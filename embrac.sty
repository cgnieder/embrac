% --------------------------------------------------------------------------
% the EMBRAC package
%
%   Upright brackets in emphasized text
% 
% --------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://bitbucket.org/cgnieder/exsheets/
% E-Mail: contact@mychemistry.eu
% --------------------------------------------------------------------------
% Copyright 2012 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% --------------------------------------------------------------------------
% > this package is strongly based on an article by Dominik Waßenhoven in
% > “Die TeXnische Komödie” 2 (2012), pp. 51--53
% > Code parts and idea used with his kind permission. Many thanks!
% --------------------------------------------------------------------------
\RequirePackage { expl3 , xparse , l3keys2e }
\ProvidesExplPackage
  {embrac}
  {2012/06/27}
  {0.0b}
  {Upright brackets in emphasized text}

\bool_new:N \l_embrac_treat_biblatex_bool

\keys_define:nn { embrac }
  { biblatex .bool_set:N = \l_embrac_treat_biblatex_bool }

% save original command:
\cs_new_eq:Nc \embrac_orig_emph:n { emph~ }
\cs_generate_variant:Nn \embrac_orig_emph:n { V }

\cs_new_eq:Nc \embrac_orig_textit:n { textit~ }
\cs_generate_variant:Nn \embrac_orig_textit:n { V }

% prepare for replacing
\cs_new_eq:NN \embrac_braces_format:n \textup
\cs_new_eq:NN \embrac_kern:n \skip_horizontal:n

% storage of the tokens to be replaced
\prop_new:N \l_embrac_emph_obrackets_prop
\prop_new:N \l_embrac_emph_obrackets_before_prop
\prop_new:N \l_embrac_emph_cbrackets_prop
\prop_new:N \l_embrac_emph_cbrackets_after_prop

% do the replacing:
\cs_new:Npn \embrac_replace_brackets:N #1
  {
    \prop_map_inline:Nn \l_embrac_emph_obrackets_prop
      {
        \tl_replace_all:Nnn #1 { ##1 }
          {
            \embrac_kern:n
              { \prop_get:Nn \l_embrac_emph_obrackets_before_prop { ##1 } }
            \embrac_braces_format:n { ##1 \embrac_kern:n { ##2 } }
          }
      }
    \prop_map_inline:Nn \l_embrac_emph_cbrackets_prop
      {
        \tl_replace_all:Nnn #1 { ##1 }
          {
            \embrac_braces_format:n
              { \embrac_kern:n { ##2 } ##1 }
            \embrac_kern:n
              { \prop_get:Nn \l_embrac_emph_cbrackets_after_prop { ##1 } }
          }
      }
  }

% internal command:
\cs_new:Npn \embrac_emph:n #1
  {
    \tl_set:Nn \l_tmpa_tl { #1 }
    \embrac_replace_brackets:N \l_tmpa_tl
    \embrac_orig_emph:V \l_tmpa_tl
  }

\cs_new:Npn \embrac_textit:n #1
  {
    \tl_set:Nn \l_tmpa_tl { #1 }
    \embrac_replace_brackets:N \l_tmpa_tl
    \embrac_orig_textit:V \l_tmpa_tl
  }

% biblatex compatibility:
\cs_new:Npn \embrac_treat_biblatex:
  {
    \bool_if:NT \l_embrac_treat_biblatex_bool
      {
        \embrac_replace_brackets:N \bibleftbracket
        \embrac_replace_brackets:N \bibrightbracket
        \embrac_replace_brackets:N \bibleftparen
        \embrac_replace_brackets:N \bibrightparen
      }      
  }

% user command:
\cs_new:Npn \embrac_new_emph:w #1#2
  {
    \group_begin:
      \embrac_treat_biblatex:
      \IfBooleanTF { #1 }
        { \embrac_orig_emph:n { #2 } }
        { \embrac_emph:n { #2 } }
    \group_end:
  }

\cs_new:Npn \embrac_new_textit:w #1#2
  {
    \group_begin:
      \embrac_treat_biblatex:
      \IfBooleanTF { #1 }
        { \embrac_orig_textit:n { #2 } }
        { \embrac_textit:n { #2 } }
    \group_end:
  }

\RenewDocumentCommand \emph { sm }
  { \embrac_new_emph:w #1 { #2 } }

\RenewDocumentCommand \textit { sm }
  { \embrac_new_emph:w #1 { #2 } }

\NewDocumentCommand \EmbracOff {}
  {
    \cs_set_eq:NN \emph   \embrac_orig_emph:n
    \cs_set_eq:NN \textit \embrac_orig_textit:n
  }

\NewDocumentCommand \EmbracOn {}
  {
    \cs_set_eq:NN \emph   \embrac_new_emph:w
    \cs_set_eq:NN \textit \embrac_new_textit:w
  }

% add, remove or renew the list
\cs_new:Npn \embrac_add_to_emph:nnnnnn #1#2#3#4#5#6
  {
    \IfNoValueTF { #2 }
      { \prop_put_if_new:Nnn \l_embrac_emph_obrackets_prop { #1 } { 0pt } }
      { \prop_put_if_new:Nnn \l_embrac_emph_obrackets_prop { #1 } { #2 } }
    \IfNoValueTF { #3 }
      { \prop_put_if_new:Nnn \l_embrac_emph_obrackets_before_prop { #1 } { 0pt } }
      { \prop_put_if_new:Nnn \l_embrac_emph_obrackets_before_prop { #1 } { #3 } }
    \IfNoValueTF { #5 }
      { \prop_put_if_new:Nnn \l_embrac_emph_cbrackets_prop { #4 } { 0pt } }
      { \prop_put_if_new:Nnn \l_embrac_emph_cbrackets_prop { #4 } { #5 } }
    \IfNoValueTF { #6 }
      { \prop_put_if_new:Nnn \l_embrac_emph_cbrackets_after_prop { #4 } { 0pt } }
      { \prop_put_if_new:Nnn \l_embrac_emph_cbrackets_after_prop { #4 } { #6 } }
  }

\cs_new:Npn \embrac_remove_from_emph:nn #1#2
  {
    \prop_del:Nn \l_embrac_emph_obrackets_prop { #1 }
    \prop_del:Nn \l_embrac_emph_obrackets_before_prop { #1 }
    \prop_del:Nn \l_embrac_emph_cbrackets_prop { #2 }
    \prop_del:Nn \l_embrac_emph_cbrackets_after_prop { #2 }
  }

\cs_new:Npn \embrac_renew_emph:nnnnnn #1#2#3#4#5#6
  {
    \prop_if_in:NnT \l_embrac_emph_obrackets_prop { #1 }
      {
        \IfNoValueF { #2 }
          { \prop_put:Nnn \l_embrac_emph_obrackets_prop { #1 } { #2 } }
        \IfNoValueF { #3 }
          { \prop_put:Nnn \l_embrac_emph_obrackets_before_prop { #1 } { #3 } }
      }
    \prop_if_in:NnT \l_embrac_emph_cbrackets_prop { #4 }
      {
        \IfNoValueF { #5 }
          { \prop_put:Nnn \l_embrac_emph_cbrackets_prop { #4 } { #5 } }
        \IfNoValueF { #6 }
          { \prop_put:Nnn \l_embrac_emph_cbrackets_after_prop { #4 } { #6 } }
      }
  }

% user commands:
\NewDocumentCommand \AddEmph { moomoo }
  {
    \embrac_add_to_emph:nnnnnn { #1 } { #2 } { #3 } { #4 } { #5 } { #6 }
    \ignorespaces
  }
\NewDocumentCommand \DeleteEmph { mm }
  {
    \embrac_remove_from_emph:nn { #1 } { #2 }
    \ignorespaces
  }
\NewDocumentCommand \RenewEmph { moomoo }
  {
    \embrac_renew_emph:nnnnnn { #1 } { #2 } { #3 } { #4 } { #5 } { #6 }
    \ignorespaces
  }

% add some defaults:
\AddEmph{(}{)}[.1em]
\AddEmph{[}{]}[.1em]

\ProcessKeysOptions { embrac }

\tex_endinput:D
% HISTORY
% TODO
- Additional optional argument to \AddEmph and \RenewEmph to add kerning to
  be used _after_ the closing bracket.