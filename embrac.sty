% --------------------------------------------------------------------------
% the EMBRAC package
%
%   Upright brackets in emphasized text
% 
% 2012/06/16
% --------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://bitbucket.org/cgnieder/exsheets/
% E-Mail: contact@mychemistry.eu
% --------------------------------------------------------------------------
% Copyright 2012 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% --------------------------------------------------------------------------
% > this package is strongly based on an article by Dominik Waßenhoven in
% > “Die TeXnische Komödie” 2 (2012), pp. 51--53
% > It is used with his kind permission. Many thanks!
% --------------------------------------------------------------------------
\RequirePackage { expl3 , xparse }
\ProvidesExplPackage
  {embrac}
  {2012/06/16}
  {0.01}
  {Upright brackets in emphasized text}

% save original command:
\cs_new_eq:Nc \embrac_orig_emph:n { emph~ }
\cs_generate_variant:Nn \embrac_orig_emph:n { V }

% prepare for replacing
\cs_new_eq:NN \embrac_braces_format:n \textup

% storage of the tokens to be replaced
\prop_new:N \l_embrac_emph_obrackets_prop
\prop_new:N \l_embrac_emph_cbrackets_prop

% internal command:
\cs_new:Npn \embrac_emph:n #1
  {
    \tl_set:Nn \l_tmpa_tl { #1 }
    \prop_map_inline:Nn \l_embrac_emph_obrackets_prop
      {
        \dim_compare:nTF { ##2 = 0pt }
          {
            \tl_replace_all:Nnn \l_tmpa_tl { ##1 }
              { \embrac_braces_format:n { ##1 } }
          }
          {
            \tl_replace_all:Nnn \l_tmpa_tl { ##1 }
              { \embrac_braces_format:n { ##1 \skip_horizontal:n { ##2 } } }
          }
      }
    \prop_map_inline:Nn \l_embrac_emph_cbrackets_prop
      {
        \dim_compare:nTF { ##2 = 0pt }
          {
            \tl_replace_all:Nnn \l_tmpa_tl { ##1 }
              { \embrac_braces_format:n { ##1 } }
          }
          {
            \tl_replace_all:Nnn \l_tmpa_tl { ##1 }
              { \embrac_braces_format:n { \skip_horizontal:n { ##2 } ##1 } }
          }
      }
    \embrac_orig_emph:V \l_tmpa_tl
  }

% user command:
\RenewDocumentCommand \emph { sm }
  {
    \IfBooleanTF { #1 }
      { \embrac_orig_emph:n { #2 } }
      { \embrac_emph:n { #2 } }
  }

% add, remove or renew the list
\cs_new:Npn \embrac_add_to_emph:nnnn #1#2#3#4
  {
    \IfNoValueTF { #2 }
      { \prop_put_if_new:Nnn \l_embrac_emph_obrackets_prop { #1 } { 0pt } }
      { \prop_put_if_new:Nnn \l_embrac_emph_obrackets_prop { #1 } { #2 } }
    \IfNoValueTF { #4 }
      { \prop_put_if_new:Nnn \l_embrac_emph_cbrackets_prop { #3 } { 0pt } }
      { \prop_put_if_new:Nnn \l_embrac_emph_cbrackets_prop { #3 } { #4 } }
  }

\cs_new:Npn \embrac_remove_from_emph:nn #1#2
  {
    \prop_del:Nn \l_embrac_emph_obrackets_prop { #1 }
    \prop_del:Nn \l_embrac_emph_cbrackets_prop { #2 }
  }

\cs_new:Npn \embrac_renew_emph:nnnn #1#2#3#4
  {
    \prop_if_in:NnT \l_embrac_emph_obrackets_prop { #1 }
      {
        \IfNoValueTF { #2 }
          { \prop_put:Nnn \l_embrac_emph_obrackets_prop { #1 } { 0pt } }
          { \prop_put:Nnn \l_embrac_emph_obrackets_prop { #1 } { #2 } }
      }
    \prop_if_in:NnT \l_embrac_emph_obrackets_prop { #3 }
      {
        \IfNoValueTF { #4 }
          { \prop_put:Nnn \l_embrac_emph_cbrackets_prop { #3 } { 0pt } }
          { \prop_put:Nnn \l_embrac_emph_cbrackets_prop { #3 } { #4 } }
      }
  }

% user commands:
\NewDocumentCommand \AddToEmph { momo }
  { \embrac_add_to_emph:nnnn { #1 } { #2 } { #3 } { #4 } }
\NewDocumentCommand \RemoveFromEmph { mm }
  { \embrac_remove_from_emph:nn { #1 } { #2 } }
\NewDocumentCommand \RenewEmph { momo }
  { \embrac_renew_emph:nnnn { #1 } { #2 } { #3 } { #4 } }

% add some defaults:
\AddToEmph{(}{)}
\AddToEmph{[}{]}

\tex_endinput:D